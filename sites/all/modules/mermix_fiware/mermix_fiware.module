<?php

function mermix_fiware_init() {
    drupal_add_library('system', 'jquery.cookie');
	drupal_add_js('jQuery(document).ready(function () { 
	if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(savePosition);
    }
	});
	function savePosition(position) {
		jQuery.cookie("geolocation",position.coords.latitude +","+position.coords.longitude);
	}
	', 'inline');
}

function mermix_fiware_views_pre_render(&$view) {
    module_load_include('inc', 'mermix_fiware');
    global $user;
    global $_supercookie;

    $userid = '';
    $location = array();

    if($user->uid > 0) {
        $userid = 'U'.$user->uid;
    } else {
        $userid = 'A'.$_supercookie->scid;
    }
    
    if ($view->name == 'machine_results' && isset($_SESSION['search_criteria'])) {
    	//get user search data
        $attrs = mfGetUserAttributesArray($userid);
        if(!isset($attrs['position'])) {
            $location = mfGetLocation($user);
        }
        unset($attrs['categories']);
        unset($attrs['cultivations']);
        unset($attrs['machines']);
        //append new data
        $attrs['searches'][REQUEST_TIME] = array('type' => $_SESSION['search_criteria']['machine_type'],
                                                 'coords' => $_SESSION['search_criteria']['coords'],
                                                 'date_from' => $_SESSION['search_criteria']['date_from'],
                                                 'date_to' => $_SESSION['search_criteria']['date_to'],
                                                );
        //update user context
        var_dump(mfUpdateUser($userid, $attrs, $location));
    }
}

function mermix_fiware_node_view($node, $view_mode, $langcode) {
    module_load_include('inc', 'mermix_fiware');
    global $user;
    global $_supercookie;

    $userid = '';
    $location = array();

    if($user->uid > 0) {
        $userid = 'U'.$user->uid;
    } else {
        $userid = 'A'.$_supercookie->scid;
    }
    
    if($view_mode == 'full') {
        //get user data
        
        $attrs = mfGetUserAttributesArray($userid);
        if(!isset($attrs['position'])) {
            $location = mfGetLocation($user);
        }

        unset($attrs['searches']);
        
        $cultivations = field_get_items('node', $node, 'field_cultivation');
        foreach ($cultivations as $key => $cultivation) {
            $index = 'tid_' . $cultivation['tid'];
            $attrs['cultivations'][$index] = isset($attrs['cultivations'][$index]) ? (int)$attrs['cultivations'][$index]+1 : 1 ;
        }
        $categories = field_get_items('node', $node, 'field_type');
        foreach ($categories as $key => $category) {
            $index = 'tid_' . $category['tid'];
            $attrs['categories'][$index] = isset($attrs['categories'][$index]) ? (int)$attrs['categories'][$index]+1 : 1 ;
        }
        $index = 'nid_' . $node->nid;
        $attrs['machines'][$index] = isset($attrs['machines'][$index]) ? (int)$attrs['machines'][$index]+1 : 1;
        var_dump(mfUpdateUser($userid, $attrs, $location));    
    }
}